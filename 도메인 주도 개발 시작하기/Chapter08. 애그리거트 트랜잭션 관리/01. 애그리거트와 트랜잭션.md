# 정리

> 두 사용자가 한 애그리거트를 동시에 변경할 때 일관성이 깨지게 된다.



![img](https://3553248446-files.gitbook.io/~/files/v0/b/gitbook-legacy-files/o/assets%2F-M5HOStxvx-Jr0fqZhyW%2F-MCvkgI26jt9I2m6y0y3%2F-MCvlY-3sW0JbdZcdfEu%2F8.1.png?alt=media&token=5d50c822-880c-40e2-8b2e-a9c3c05fea3e)

한 애그리거트를 두 사용자가 동시에 변경할 때 트랜잭션이 필요하다.

운영자 스레드와 고객 스레드는 개념적으로 동일한 애그리거트지만 물리적으로 서로 다른 애그리거트 객체를 사용한다.

이 상황에서 두 스레드는 각각 트랜잭션을 커밋할 때 수정한 내용을 DB에 반영한다.

이 때, 애그리거트의 **일관성**이 깨지게 된다.

일관성이 깨지는 것을 막기 위해 다음 두 가지 중 하나를 해야 한다.

- 운영자가 배송지 정보를 조회하고 상태를 변경하는 동안, 고객이 애그리거트를 수정하지 못하게 막는다.
- 운영자가 배송지 정보를 조회한 이후에 고객이 정보를 변경하면, 운영자가 애그리거트를 다시 조회한 뒤 수정하도록 한다.



DBMS가 지원하는 트랜잭션과 함께 애그리거트를 위한 추가적인 트랜잭션 기법으로 **선점(비관적) 잠금과 비선점(낙관적) 잠금**이 있다.



# 느낀점

동시성을 처리하기 위한 고민은 끊임없이 이루어진다.

애그리거트의 일관성을 유지하기 위해 트랜잭션 기법을 이용해야 한다.
